<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¥ Broadcaster - Amiim Initiative</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ğŸ¥ Broadcaster - Amiim Initiative</h1>

  <input type="text" id="roomId" placeholder="Enter Room ID to broadcast" />
  <button onclick="startBroadcast()">ğŸ¥ Start Broadcast</button>

  <div id="videos">
    <video id="mainVideo" autoplay playsinline muted></video>
    <div id="viewerStreams"></div>
  </div>

  <div id="viewerCount">ğŸ‘¥ Viewers: 0</div>

  <textarea id="chat-box" class="chat-box" readonly></textarea><br>
  <input id="chat-input" type="text" placeholder="Type your comment..." />
  <button onclick="sendMessage()">ğŸ’¬ Send</button>

  <div id="music-controls">
    <button onclick="toggleMusic()">ğŸµ Toggle Music</button>
    <audio id="background-music" loop muted>
      <source src="bring_me.mp3" type="audio/mp3" />
    </audio>
  </div>

  <footer><div class="footer-text">ğŸ”Œ Powered by Amiim Initiative</div></footer>

<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
const socket = io("https://amiim-live-broadcast-3.onrender.com");

const mainVideo = document.getElementById("mainVideo");
const chatBox = document.getElementById("chat-box");
const chatInput = document.getElementById("chat-input");
const viewerCount = document.getElementById("viewerCount");
const backgroundMusic = document.getElementById("background-music");
const viewerStreams = document.getElementById("viewerStreams");

let roomId, localStream;
const viewerPeers = {};
const viewerNames = {};

async function startBroadcast() {
  roomId = document.getElementById("roomId").value.trim();
  if (!roomId) return alert("Enter a Room ID");

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    mainVideo.srcObject = localStream;
    socket.emit("broadcaster-join", { roomId, name: "Amiim" });
  } catch (err) {
    alert("Camera/Mic access denied: " + err.message);
  }
}

// ğŸ“¡ Send stream to each viewer
socket.on("viewer-join", ({ viewerId, name }) => {
  const peer = new SimplePeer({
    initiator: true,
    trickle: false,
    stream: localStream
  });

  peer.on("signal", signal => {
    socket.emit("signal-to-viewer", { roomId, viewerId, signal });
  });

  viewerPeers[viewerId] = peer;
  viewerNames[viewerId] = name;
});

// ğŸ’¬ Handle signal from viewer
socket.on("signal-from-viewer", ({ viewerId, signal, name }) => {
  const peer = new SimplePeer({
    initiator: false,
    trickle: false
  });

  peer.on("signal", s => {
    socket.emit("signal-from-broadcaster", { signal: s, viewerId });
  });

  peer.on("stream", (stream) => {
    const vid = document.createElement("video");
    vid.srcObject = stream;
    vid.autoplay = true;
    vid.playsInline = true;
    vid.style.width = "200px";
    vid.style.border = "2px solid #0f0";

    const label = document.createElement("div");
    label.innerText = `ğŸ¤ ${name}`;

    const allowMicBtn = document.createElement("button");
    allowMicBtn.innerText = "ğŸ™ï¸ Allow Mic";
    allowMicBtn.onclick = () => {
      socket.emit("allow-mic", { roomId, viewerName: name });
    };

    const container = document.createElement("div");
    container.style.marginBottom = "10px";
    container.appendChild(vid);
    container.appendChild(label);
    container.appendChild(allowMicBtn);
    viewerStreams.appendChild(container);
  });

  peer.signal(signal);
  viewerPeers[viewerId] = peer;
  viewerNames[viewerId] = name;
});

// ğŸ–ï¸ Viewer raised hand
socket.on("raise-hand", (senderName) => {
  chatBox.value += `âœ‹ ${senderName} raised their hand\n`;
  chatBox.scrollTop = chatBox.scrollHeight;
});

// ğŸ“¨ Chat from broadcaster
function sendMessage() {
  const msg = chatInput.value.trim();
  if (msg) {
    socket.emit("chat", { roomId, sender: "Amiim", message: msg });
    chatInput.value = "";
  }
}

// ğŸ“¬ Chat incoming
socket.on("chat", ({ sender, message }) => {
  const time = new Date().toLocaleTimeString();
  chatBox.value += `[${time}] ${sender}: ${message}\n`;
  chatBox.scrollTop = chatBox.scrollHeight;
});

// ğŸ”Š Toggle music
function toggleMusic() {
  backgroundMusic.muted = false;
  if (backgroundMusic.paused) backgroundMusic.play();
  else backgroundMusic.pause();
}

// ğŸ‘¥ Update viewer count
socket.on("viewer-count", count => {
  viewerCount.textContent = `ğŸ‘¥ Viewers: ${count}`;
});
</script>

</body>
</html>
