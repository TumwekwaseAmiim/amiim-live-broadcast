<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸŽ¥ Broadcaster - Amiim Initiative</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ðŸŽ¥ Broadcaster - Amiim Initiative</h1>

  <input type="text" id="roomId" placeholder="Enter Room ID" />
  <button onclick="startBroadcast()">Start Broadcast</button>
  <button onclick="shareScreen()">Share Screen</button>

  <video id="screenVideo" autoplay muted playsinline></video>
  <video id="selfPreview" autoplay muted playsinline></video>

  <div id="status"></div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const socket = io();
    const screenVideo = document.getElementById("screenVideo");
    const selfPreview = document.getElementById("selfPreview");
    const status = document.getElementById("status");
    let localStream;
    let peers = [];

    function startBroadcast() {
      const roomId = document.getElementById("roomId").value.trim();
      if (!roomId) {
        alert("Please enter a Room ID");
        return;
      }
      status.textContent = `Broadcasting Room: ${roomId}`;
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          localStream = stream;
          selfPreview.srcObject = stream;
          socket.emit("broadcaster-join", roomId);

          socket.on("viewer-join", (viewerId) => {
            const peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream });
            peer.on("signal", (signal) => {
              socket.emit("signal-to-viewer", { viewerId, signal });
            });
            peer.on("connect", () => {
              console.log(`Connected to viewer: ${viewerId}`);
            });
            peers[viewerId] = peer;
          });

          socket.on("signal-from-viewer", ({ viewerId, signal }) => {
            if (peers[viewerId]) {
              peers[viewerId].signal(signal);
            }
          });

          socket.on("viewer-disconnected", (viewerId) => {
            if (peers[viewerId]) {
              peers[viewerId].destroy();
              delete peers[viewerId];
            }
          });
        })
        .catch((err) => {
          console.error("Error getting media:", err);
          alert("Failed to access camera/microphone.");
        });
    }

    function shareScreen() {
      navigator.mediaDevices.getDisplayMedia({ video: true, audio: true })
        .then((screenStream) => {
          screenVideo.srcObject = screenStream;
        })
        .catch((err) => {
          console.error("Error sharing screen:", err);
          alert("Failed to share screen.");
        });
    }
  </script>
</body>
</html>
